local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local function createESP(player)
    local function applyHighlight()
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            if player.Character:FindFirstChild("Highlight") then
                player.Character.Highlight:Destroy()
            end

            local highlight = Instance.new("Highlight")
            highlight.Name = "Highlight"
            highlight.Adornee = player.Character
            highlight.FillTransparency = 0.7
            highlight.OutlineTransparency = 0.3
            highlight.FillColor = player.Team and player.Team.TeamColor.Color or Color3.new(1, 1, 1)
            highlight.OutlineColor = Color3.new(0, 0, 0)
            highlight.Parent = player.Character
        end
    end

    local function createNameTags()
        local nameTag = Drawing.new("Text")
        local teamTag = Drawing.new("Text")

        nameTag.Text = player.Name
        nameTag.Size = 16
        nameTag.Center = true
        nameTag.Outline = true
        nameTag.Color = Color3.new(1, 1, 1)
        nameTag.Transparency = 1

        teamTag.Text = player.Team and player.Team.Name or "No Team"
        teamTag.Size = 14
        teamTag.Center = true
        teamTag.Outline = true
        teamTag.Color = player.Team and player.Team.TeamColor.Color or Color3.new(1, 1, 1)
        teamTag.Transparency = 1

        RunService.RenderStepped:Connect(function()
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local humanoidRootPart = player.Character.HumanoidRootPart
                local screenPos, onScreen = Camera:WorldToViewportPoint(humanoidRootPart.Position + Vector3.new(0, 3, 0))

                if onScreen then
                    nameTag.Visible = true
                    teamTag.Visible = true
                    nameTag.Position = Vector2.new(screenPos.X, screenPos.Y - 15)
                    teamTag.Position = Vector2.new(screenPos.X, screenPos.Y - 30)
                else
                    nameTag.Visible = false
                    teamTag.Visible = false
                end
            else
                nameTag.Visible = false
                teamTag.Visible = false
            end
        end)
    end

    applyHighlight()
    createNameTags()

    player.CharacterAdded:Connect(function()
        applyHighlight()
        createNameTags()
    end)
end

local function aimbot()
    local closestTarget = nil
    local closestDistance = _G.fov

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local targetPosition = player.Character.HumanoidRootPart.Position
            local screenPos, onScreen = Camera:WorldToViewportPoint(targetPosition)
            local distance = (Camera.CFrame.Position - targetPosition).Magnitude

            if onScreen and distance < closestDistance then
                closestDistance = distance
                closestTarget = player
            end
        end
    end

    if closestTarget then
        local targetPosition = closestTarget.Character.HumanoidRootPart.Position
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, targetPosition)
    end
end

game:GetService("UserInputService").InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode[_G.aimbotKey] then
        _G.aimbotEnabled = not _G.aimbotEnabled
        print(_G.aimbotEnabled and "Aimbot Ativado" or "Aimbot Desativado")
    end
end)

local function toggleESP()
    if _G.espEnabled then
        _G.espEnabled = false
        print("ESP Desativado")
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= Players.LocalPlayer then
                if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart:FindFirstChild("Highlight") then
                        rootPart.Highlight:Destroy()
                    end
                    if player.Character:FindFirstChild("NameTag") then
                        player.Character.NameTag:Destroy()
                    end
                end
            end
        end
    else
        _G.espEnabled = true
        print("ESP Ativado")
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= Players.LocalPlayer then
                createESP(player)
            end
        end
    end
end

for _, player in pairs(Players:GetPlayers()) do
    if player ~= Players.LocalPlayer then
        createESP(player)
    end
end

Players.PlayerAdded:Connect(function(player)
    if player ~= Players.LocalPlayer then
        createESP(player)
    end
end)

RunService.RenderStepped:Connect(function()
    if _G.aimbotEnabled then
        aimbot()
    end
end)
